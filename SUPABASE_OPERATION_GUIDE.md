# Supabase 運用管理ガイド

このドキュメントでは、Supabaseを利用した本システムの運用方法、アカウント管理、無料枠の制限、および同時編集への対応について詳しく解説します。

## 1. アカウントの追加と登録方法

個別アカウントの運用には、主に以下の2通りの方法があります。

### A. 管理者がユーザーを招待する (推奨)
管理者がSupabaseの管理画面からスタッフのメールアドレスを入力し、招待メールを送信する方法です。
- **手順**: Supabase Dashboard > Authentication > Users > 「Invite user」
- **メリット**: 許可した人だけがシステムに参加できるため、セキュリティが高いです。
- **管理者の役割**: 全スタッフのメールアドレスを把握し、個別に招待を送る必要があります。

### B. ユーザー自身でサインアップする
アプリ上に「新規登録」画面を作り、ユーザーが自由にアカウントを作成する方法です。
- **手順**: アプリにサインアップ機能を実装（現在は未実装。追加が必要）。
- **メリット**: 管理者の手間が省けます。
- **注意点**: 誰でもアカウントを作れてしまうため、特定のドメイン（例：@company.com）のみ許可するなどの制限が必要です。

---

## 2. Supabase 無料枠 (Free Tier) の制限

現在使用している無料プランでは、以下の範囲内で利用可能です。

| 項目 | 無料枠の制限 | 備考 |
| :--- | :--- | :--- |
| **ユーザー数** | **50,000人** (Monthly Active Users) | 今回のような運用では十分すぎる枠です。 |
| **データベース容量** | **500 MB** | テキストデータ中心であれば、数万件の依頼データも余裕で入ります。 |
| **ストレージ (画像等)** | **5 GB** | 添付ファイルなどを使わなければ消費しません。 |
| **同時接続数** | **200** | 同時にアプリを開いている人数です。 |
| **プロジェクトの停止** | **1週間アクセスがないと一時停止** | 管理画面から再開可能ですが、毎日運用していれば問題ありません。 |

**結論**: 小規模〜中規模の施設内運用であれば、無料枠の範囲内で長期的に運用することが十分に可能です。

---

## 3. 編集の排他ロック（同時編集への対応）について

「複数の人が同じデータを同時に編集し、上書きしてしまう」問題への対策には、主に以下の考え方があります。

### 現状（対策なし）
- 後から保存ボタンを押した人の内容が最終的に残ります（後勝ち）。
- 短い情報の更新であれば大きな問題になりにくいですが、長時間の入力ではリスクがあります。

### 今後の対策案：楽観的ロック (Optimistic Locking)
データに「バージョン番号」や「更新日時」を紐づけ、保存時に自分が開いた時のバージョンと一致するかチェックする方法です。
- **仕組み**: 保存ボタンを押した際、「もし、自分が開いた後に誰かが更新していたら、エラーを出して保存を中断する」という処理をプログラムに追加します。
- **実装**: データベースに `updated_at` カラムを持たせ、保存条件に `eq('updated_at', 開いた時の日時)` を加えることで実現できます。

### 今後の対策案：悲観的ロック (Pessimistic Locking / 画面ロック)
誰かが編集画面を開いている間、他の人は「編集ボタン」を押せないように（読み取り専用に）する方法です。
- **仕組み**: 誰かが編集を開始した瞬間に「〇〇さんが編集中」というフラグをデータベースに立てます。
- **難点**: ブラウザを閉じてしまった際にロックが残り続ける（ロックの残留）問題が発生しやすいため、解除タイマーなどの高度な制御が必要になります。

---

## 4. 本運用に向けたステップ

1. **個別アカウントの決定**: 各スタッフのメールアドレスでログインする運用に切り替える。
2. **監査ログの記録**: プログラムを修正し、各依頼データに `created_by`（作成者ID）や `updated_by`（最終更新者ID）を自動で保存するようにする。
3. **同時編集ルールの策定**: システム的なロックを実装するまでは、「一覧画面で誰かが詳細を開いていたら声をかける」などの運用ルールを設ける。

このガイドについて不明な点や、上記機能（楽観的ロックや作成者記録など）の追加実装が必要な場合は、いつでもご相談ください。
